<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Th·∫ª T√≠ch ƒêi·ªÉm</title>
<style>
body{font-family:sans-serif;padding:20px;}
input, button{padding:8px;margin:5px 0;width:100%;}
.item{border:1px solid #ccc;padding:10px;border-radius:8px;margin-top:10px;}
.section{margin-top:25px;padding-top:10px;border-top:2px solid #eee;}
</style>
</head>
<body>
<h2>Th·∫ª T√≠ch ƒêi·ªÉm C√° Nh√¢n</h2>

<input id="searchPhone" placeholder="T√¨m theo 4 s·ªë cu·ªëi s·ªë ƒëi·ªán tho·∫°i">
<button onclick="searchCustomer()">T√¨m ki·∫øm</button>

<hr>
<input id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
<input id="name" placeholder="T√™n kh√°ch (n·∫øu t·∫°o m·ªõi)">
<input id="food" placeholder="M√≥n ƒÉn h√¥m nay">
<button onclick="addPoint()">C·ªông ƒëi·ªÉm (+1)</button>
<button onclick="subPointByPhone()">Tr·ª´ ƒëi·ªÉm (-1)</button>

<div id="result"></div>

<div class="section">
<h3>Danh s√°ch kh√°ch h√†ng</h3>
<div id="list"></div>
</div>

<div class="section">
<h3>T·ªïng s·ªë ƒëi·ªÉm</h3>
<div id="totalPoints"></div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("customers") || "[]");

// Thay b·∫±ng URL Web App c·ªßa b·∫°n
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFBbA6eVg165WWKQH0yKkTBn6h3joYXifetN22g1D2Dz6yP-bBObSLe7tUWvZJyuU3kQ/exec";

async function syncToDrive(c){
  try{
    await fetch(GOOGLE_SCRIPT_URL,{
      method:"POST",
      body: JSON.stringify({action:"addOrUpdateCustomer", data:c}),
      headers:{"Content-Type":"application/json"}
    });
  }catch(e){console.error("Sync failed",e);}
}

async function loadFromDrive(){
  try{
    let res = await fetch(GOOGLE_SCRIPT_URL+"?action=getAllCustomers");
    let arr = await res.json();
    if(Array.isArray(arr)){data=arr; save(); render();}
  }catch(e){console.warn("Load failed",e);}
}

function save(){ localStorage.setItem("customers", JSON.stringify(data)); }
function today(){ return new Date().toISOString().split("T")[0]; }
function addDays(n){ let d=new Date(); d.setDate(d.getDate()+n); return d.toISOString().split("T")[0]; }
function getFavoriteFood(arr){ if(!arr||arr.length===0)return null; let map={}; arr.forEach(x=>map[x]=(map[x]||0)+1); return Object.keys(map).sort((a,b)=>map[b]-map[a])[0]; }
function getFoodCounts(arr){ let map={}; arr.forEach(x=>map[x]=(map[x]||0)+1); return map; }

function render(){
  let box=document.getElementById("list"); box.innerHTML="";
  let total=0;
  data.forEach(c=>{
    total+=c.points;
    let div=document.createElement("div"); div.className="item";
    let favFood=getFavoriteFood(c.foodHistory||[]);
    let expireText="";
    if(c.expireDate){ let diff=Math.ceil((new Date(c.expireDate)-new Date())/86400000); expireText=diff<0?"H·∫øt h·∫°n":diff+" ng√†y c√≤n l·∫°i"; }
    let foodCounts=getFoodCounts(c.foodHistory||[]);
    let foodListHtml="";
    for(let f in foodCounts){ foodListHtml+=f+" ("+foodCounts[f]+" l·∫ßn)<br>"; }
    div.innerHTML=`<b>${c.name} (${c.phone})</b><br>
M√≥n th∆∞·ªùng ƒÉn: ${favFood||"‚Äî"}<br>
ƒêi·ªÉm: ${c.points}<br>
Qu√† t·∫∑ng: ${c.gifts}<br>
S·ªë l·∫ßn mua: ${c.purchaseCount||0}<br>
Danh s√°ch m√≥n ƒÉn:<br>${foodListHtml}
H·∫°n: ${c.expireDate} (${expireText})<br><br>
<button onclick="subPoint('${c.phone}')">-1</button>
<button onclick="del('${c.phone}')">Xo√°</button>`;
    box.appendChild(div);
  });
  document.getElementById("totalPoints").textContent=total+" ƒëi·ªÉm";
}

function addPoint(){
  let phone=document.getElementById("phone").value.trim();
  let name=document.getElementById("name").value.trim();
  let food=document.getElementById("food").value.trim();
  if(!phone)return alert("Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!");
  let c=data.find(x=>x.phone===phone);
  if(!c){ c={phone,name:name||"Ch∆∞a ƒë·∫∑t t√™n",points:0,gifts:0,purchaseCount:0,startDate:today(),expireDate:addDays(15),foodHistory:[]}; data.push(c); }
  c.purchaseCount=(c.purchaseCount||0)+1;
  if(food)c.foodHistory.push(food);
  if(new Date(c.expireDate)<new Date()){c.points=0;c.startDate=today();c.expireDate=addDays(15);}
  c.points+=1;
  if(c.points>=6){c.gifts+=1;c.points=0;c.startDate=today();c.expireDate=addDays(15); alert("Kh√°ch ƒë·∫°t 6 ƒëi·ªÉm! +1 qu√† t·∫∑ng üéÅ");}
  save(); render(); syncToDrive(c);
}

function subPoint(phone){ let c=data.find(x=>x.phone===phone); if(!c)return; c.points=Math.max(0,c.points-1); save(); render(); syncToDrive(c);}
function subPointByPhone(){ let phone=document.getElementById("phone").value.trim(); if(!phone)return alert("Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!"); subPoint(phone);}
function del(phone){ if(!confirm("Xo√° kh√°ch n√†y?")) return; data=data.filter(x=>x.phone!==phone); save(); render(); syncToDrive({phone:phone,deleted:true}); }

function searchCustomer(){
  let last4=document.getElementById("searchPhone").value.trim();
  if(!last4)return alert("Nh·∫≠p 4 s·ªë cu·ªëi!");
  let matched=data.filter(c=>c.phone.slice(-4)===last4);
  let box=document.getElementById("result");
  if(matched.length===0){document.getElementById("phone").value=last4;document.getElementById("name").value="";box.innerHTML="<p>Kh√¥ng t√¨m th·∫•y, t·∫°o m·ªõi h·ªì s∆° v·ªõi s·ªë ƒëi·ªán tho·∫°i n√†y.</p>";return;}
  let html="";
  matched.forEach(c=>{
    let favFood=getFavoriteFood(c.foodHistory||[]);
    let foodCounts=getFoodCounts(c.foodHistory||[]);
    let foodListHtml="";
    for(let f in foodCounts){foodListHtml+=f+" ("+foodCounts[f]+" l·∫ßn)<br>";}
    html+=`<div class="item"><b>${c.name} (${c.phone})</b><br>M√≥n th∆∞·ªùng ƒÉn: ${favFood||"‚Äî"}<br>ƒêi·ªÉm: ${c.points}<br>Qu√† t·∫∑ng: ${c.gifts}<br>S·ªë l·∫ßn mua: ${c.purchaseCount||0}<br>Danh s√°ch m√≥n ƒÉn:<br>${foodListHtml}<br>H·∫°n: ${c.expireDate}</div>`;
  });
  box.innerHTML=html;
}

render(); loadFromDrive();
</script>
</body>
</html>
